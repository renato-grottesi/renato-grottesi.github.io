<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Zelda1.5</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <script type="module">
        // 1. HARDCODED STRUDEL SONG STRING
        const HARDCODED_STRUDEL_CODE = `
    setcpm(40)

    // drums pattern
    $: s("[bd <hh oh*2>]*2").bank("ry30").dec(.4).gain(.7)

    $: s("[oh ~ rim*2 ~]/2").bank("ry30").dec(.4).gain(.7)

    // bass IV-V-I-vi progression
    $: n("[[-3,0,2,4] [-3,0,2,4] [0,2,4] [0,2,4]]/2")
      .scale("[F3:major G3:major C3:major A3:minor]/2")
      .sound("gm_acoustic_bass")
      .gain(0.75)

    // arpeggio
    $: n("<0 <2 4> 3 <5 7> 8 <11 12> 15 <5 7> 12 6 4 0>*4")
      .scale("[F3:major G3:major C3:major A3:minor]/2")
      .sound("gm_celesta")
      .gain(0.4)

    // melody
    $: n("<0 2 3/4 5*2 7 9*2 11 12*2 13 >*2")
      .scale("[F4:major G4:major C4:major A4:minor]/2")
      .sound("piano")
            `; 

        // 2. Import the necessary Strudel modules from CDN
        //import { repl } from "https://unpkg.com/@strudel/core@1.2.5/dist/core.mjs";
        //import { initAudioOnFirstClick, webaudioOutput } from "https://unpkg.com/@strudel/webaudio@1.2.5/dist/webaudio.mjs";
        import { repl } from "https://cdn.jsdelivr.net/npm/@strudel/core@1.2.5/dist/core.min.js";
        import { initAudioOnFirstClick, webaudioOutput } from "https://cdn.jsdelivr.net/npm/@strudel/webaudio@1.2.5/dist/webaudio.min.js";
        //import { repl } from "https://cdn.jsdelivr.net/npm/@strudel/core@1.2.5/+esm";
        //import { initAudioOnFirstClick, webaudioOutput } from "https://cdn.jsdelivr.net/npm/@strudel/webaudio@1.2.5";

        // Get the start button element
        const playMusic = document.getElementById('play-music');

        // 3. Initialize the Strudel environment
        const { scheduler } = repl({
            defaultOutput: webaudioOutput,
        });

        // Function to set the pattern and start the music
        function startStrudelMusic() {
            try {
                // Set the hardcoded pattern in the Strudel scheduler
                scheduler.setPattern(HARDCODED_STRUDEL_CODE);
                // Start the playback
                scheduler.start();
            } catch (error) {
                console.error("Error playing Strudel song:", error);
                playMusic.textContent = 'Error playing music.';
                playMusic.disabled = true;
            }
        }

        // 4. Attach the function to the button click for guaranteed playback
        playMusic.addEventListener('click', () => {
            // The first click initializes the Web Audio API and then runs your function
            initAudioOnFirstClick(() => {
                startStrudelMusic();
            })(); // The immediate function call is how initAudioOnFirstClick works
        }, { once: true }); // Ensure the event listener is only run once
    </script>
    
    <div class="outerContainer">
        <h3 class="written-in-ink"><a href="https://www.inklestudios.com/ink">WRITTEN IN INK</a></h3>

        <div id="controls" class="buttons">
          <a id="rewind" title="Restart story from beginning">restart</a>
          <a id="save" title="Save progress">save</a>
          <a id="reload" title="Reload from save point">load</a>
          <a id="theme-switch" title="Switch theme">theme</a>
          <a id="play-music" title="Play music">music</a>
        </div>

        <div id="story" class="container">
            <div class="header">
                <h1>Zelda1.5</h1>
                <h2 class="byline"></h2>
            </div>
        </div>
    </div>

    <script src="ink.js"></script>
    <script src="story.js"></script>
    <script src="main.js"></script>
</body>
</html>
